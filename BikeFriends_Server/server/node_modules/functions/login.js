var crypto = require('crypto');
var rand = require('csprng');
var mongoDB = require('mongoskin');
var BSON = require('mongodb').BSONPure;
var db = mongoDB.db('mongodb://localhost/mydb?auto_reconnect=true', {
    safe: true
});

db.bind('profiles');

var profilesCollection = db.profiles;


exports.login = function(email,password,callback) {

	profilesCollection.find({email: email}).toArray(function(error, results) {
		  	console.log(results);
		if (error)
    		next(error);
    	else if(results.length == 0){
    		callback({'response':"Email not registered"})
    	}
		else {
			console.log(results);
			var temp = results[0].salt;
			var hash_db = results[0].hashed_password;
			var token = results[0].token;
			var id = results[0]._id;
			var username = results[0].username;
			var newpass = temp + password;
			var hashed_password = crypto.createHash('sha512').update(newpass).digest("hex");
			if(hash_db == hashed_password){
				callback({'response':"Login Sucess",'res':true,'token':token,'userID':id, 'username':username});
			}else{
				callback({'response':"Invalid Password",'res':false});
			};
		};
	});
}